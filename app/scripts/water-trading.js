(function(d3, $, _) {
  'use strict';

  var $vis = $('#water-trading-vis');
  var vis = d3.select($vis[0]);

  var states = [
    { id: "NSW", points: "97.795,136.285 121.298,143.279 188.727,177.973 198.52,181.609 237.968,198.676 248.74,197.138 262.589,204.271 260.071,207.63 268.606,212.535 294.514,227.812 294.514,0 76.888,0 77.931,131.021" },
    { id: "SA", points: "12.04,149.701 13.586,150.218 14.105,153.309 15.133,153.309 16.679,160.524 15.133,158.461 13.586,160.009 14.105,166.711 16.165,166.711 14.105,177.02 12.04,178.05 11.525,183.203 11.012,183.203 5.342,188.359 20.286,187.328 23.38,183.72 25.958,184.232 23.894,180.625 25.958,180.109 27.5,182.172 30.081,182.172 29.048,181.141 29.048,179.597 34.203,178.05 34.203,175.988 37.809,179.597 39.357,179.08 38.324,183.72 36.779,184.232 36.263,182.688 35.235,183.203 35.235,184.75 36.779,185.265 37.296,188.875 35.235,189.904 50.178,223.403 47.088,229.073 45.544,229.59 65.125,259.484 72.265,258.973 74.414,261.225 72.98,0 0,0 0,159.332 6.884,138.362" },
    { id: "SA-bit", points: "3.795,191.448 1.733,191.448 0.701,194.025 0,193.745 0,196.913 7.403,196.09" },
    { id: "VIC", points: "230.795,297.235 229.634,296.718 227.315,298.782 225.576,291.565 253.359,275.209 254.516,276.75 274.923,267.19 274.34,265.126 279.555,261.516 280.716,263.063 288.252,263.063 288.252,261.004 294.514,258.902 294.514,232.198 283.231,224.922 259.024,210.367 253.355,211.267 246.361,209.588 239.498,205.408 194.449,197.142 193.239,201.441 137.805,173.775 121.857,171.816 110.105,156.429 88.806,150.756 84.638,151.191 77.609,147.646 77.159,268.836 86.449,273.144 85.871,270.566 139.768,285.001 160.667,279.195 158.928,277.65 158.928,276.618 161.245,276.618 162.982,278.167 164.722,278.167 166.461,272.494 164.145,274.046 164.145,274.559 161.824,274.559 160.667,273.008 157.189,272.494 157.77,270.436 170.535,264.211 177.968,268.847 184.428,273.008 180.951,275.588 180.951,277.135 173.997,280.227 180.371,284.351 188.483,281.774 187.323,280.742 191.167,279.223 190.8,279.709 191.386,281.258 193.702,281.258 194.857,280.227 194.281,278.68 193.166,278.433 197.757,276.618 195.441,287.443 203.556,292.08 209.35,290.535 214.561,297.752 216.3,297.752 217.464,296.205 228.474,306 230.211,304.453" }
  ];

  var regions = [
    { id: "NSW_Murrumbidgee", seller: true, points: "186.911,116.598 244.227,106.723 276.857,133.766 283.713,134.536 277.696,159.786 268.674,172.586 255.455,169.439 233.631,173.217 161.447,132.717 160.396,128.311 175.716,123.694" },
    { id: "NSW_Lower_Darling", seller: true, points: "96.181,104.118 99.375,93.459 97.304,90.035 93.599,80.607 87.583,64.686 114.022,48.151 133.328,43.115 157.67,47.732 184.948,39.758 200.057,53.607 214.746,84.244 178.234,100.611 177.813,120.336 165.644,124.113 158.509,125.793" },
    { id: "SA_Murray", seller: false, points: "17.122,164.402 19.84,142.58 10.782,121.176 14.857,99.354 31.162,83.404 36.143,84.243 51.089,77.948 73.733,81.306 73.281,166.082 37.049,171.538" },
    { id: "VIC_Murray", seller: false, points: "244.682,226.234 237.688,221.061 198.517,221.352 191.383,214.027 184.248,217.445 170.26,222.738 101.014,184.128 90.24,158.847 77.301,154.541 77.301,146.025 91.08,146.076 98.914,139.222 108.566,142.999 119.688,156.219 124.725,156.219 131.859,162.724 259.23,210.148 255.874,221.34" },
    { id: "NSW_Murray", seller: true, points: "77.091,81.248 91.64,85.364 95.557,95.995 94.088,105.019 146.758,124.113 158.089,128.311 159.559,133.557 232.792,176.153 247.48,174.475 262.589,179.931 270.143,186.086 265.945,200.915 260.35,207.91 202.575,185.807 132.068,159.788 124.096,153.74 120.318,153.74 109.406,140.264 97.655,136.081 91.36,142.998 77.58,142.93" },
    { id: "VIC_Goulburn", seller: false, points: "232.833,223.196 209.089,223.873 197.021,223.799 189.585,217.293 169.185,225.68 147.705,213.918 146.18,224.48 175.203,239.176 177.672,257.502 189.244,262.474 209.512,264.764 209.526,264.766 210.987,264.931 210.985,264.896 227.597,266.385 229.694,254.215 249.131,251.391" }
  ];

  var arrows = [
    { id: "SA_to_VIC_Murray", d: "M93.115,153.785l-3.912-4.361l-0.459,1.404c-8.233-2.511-16.894-2.449-25.109,0.201 l0.902,2.797c7.622-2.461,15.655-2.523,23.293-0.206l-0.449,1.373L93.115,153.785z" },
    { id: "NSW_Murray_to_Murrumbidgee", d: "M229.786,152.647l-8.195-0.339l0.966,1.846 c-8.073,4.656-13.271,12.746-13.327,20.922l4.113,0.027c0.046-6.684,4.377-13.361,11.121-17.308l0.933,1.78L229.786,152.647z" },
    { id: "NSW_Murray_to_Lower_Darling", d: "M122.957,80.069l-2.77-3.136l-0.336,1.001 c-16.266-5.167-32.037,1.79-38,11.643l1.795,1.086c5.536-9.147,20.271-15.576,35.538-10.739l-0.327,0.976L122.957,80.069z" },
    { id: "VIC_Murray_to_Goulburn", d: "M218.39,214.983l-2.107-4.107c-4.742,2.435-7.893,6.686-8.494,11.313 l-2.377-0.051l4.434,8.066l4.771-7.871l-2.17-0.046C213.025,219.37,215.239,216.601,218.39,214.983z" },
    { id: "Murrumbidgee_to_SA", d: "M61.141,118.5l-0.719-2.219l-20.179,22.373l29.465,6.295l-0.808-2.494 c41.369-12.689,84.903-12.32,126.126,1.115l7.803-23.941C156.517,104.533,107.603,104.161,61.141,118.5z" },
    { id: "Lower_Darling_to_SA", d: "M61.312,81.383l-1.867-1.004l0.252,8.366l7.12-4.4l-1.808-0.973 c7.545-12.527,27.373-21.379,48.629-14.888l1.227-4.014C91.531,57.344,69.65,67.361,61.312,81.383z" },
    { id: "Murrumbidgee_to_Gouldburn", d: "M272.602,171.719l-5.676-11.707c-25.834,12.524-43.161,35.367-45.834,60.114 l-3.291-0.204l8.667,17.422l10.757-16.215l-3.124-0.194C236.53,201.104,251.354,182.02,272.602,171.719z" },
    { id: "Gouldburn_to_VIC_Murray", d: "M214.746,199.563l-16.292-0.958l1.246,2.483 c-10.214,5.92-16.701,15.84-17.099,26.372l10.904,0.412c0.244-6.486,4.535-12.947,11.106-16.993l1.161,2.315L214.746,199.563z" },
    { id: "NSW_Murray_to_SA", d: "M62.264,92.923l-0.531-1.659l-2.222,2.445c-0.024,0.008-0.049,0.014-0.074,0.022 l0.014,0.044L48.227,106.13l16.31,3.547l0.014,0.044c0.027-0.009,0.055-0.014,0.082-0.022l3.221,0.7l-0.465-1.455c6.325-1.467,12.867-1.178,19.088,0.875l5.261-15.941C82.125,90.706,71.998,90.393,62.264,92.923z" },
    { id: "Murrumbidgee_to_VIC_Murray", d: "M216.702,153.763l-7.662-14.936c-17.246,8.847-28.608,24.451-30.379,41.347 l-4.318-0.094l12.083,22.01l13.023-21.467l-3.887-0.084C197.265,169.884,205.217,159.655,216.702,153.763z" }
  ];

  var yoink = function(prop, fn) {
    fn = fn || _.identity;
    return function(data) { return fn(data[prop]); };
  };

  var aspectRatio = function(width) {
    return width * (306/295);
  };

  var scale = function(width) {
    return width / 295;
  };

  var render = function(graphWidth) {
    $vis.empty();
    var scaled = scale(graphWidth);
    var svg = vis.append('svg')
        .attr('width', graphWidth)
        .attr('height', aspectRatio(graphWidth))
        .attr('viewBox', ['0', '0', graphWidth, aspectRatio(graphWidth)].join(' '))
        .append('g')
          .attr('transform', 'scale(' + scaled + ')');

    // render states
    svg.append('g')
      .selectAll('polygon').data(states).enter().append('polygon')
        .attr('id', yoink('id'))
        .attr('fill', '#FFFFFF')
        .attr('fill-opacity', 0.15)
        .attr('points', yoink('points'));

    // render regions
    svg.append('g')
      .selectAll('polygon').data(regions).enter().append('polygon')
        .attr('id', yoink('id'))
        .attr('fill', function(d) { return d.seller ? '#004892' : '#1AAB45' })
        .attr('points', yoink('points'));

    // render arrows
    svg.append('g')
      .selectAll('path').data(arrows).enter().append('path')
        .attr({ id: yoink('id'), d: yoink('d'), class: 'arrow', style: 'fill-opacity: 0.95' });

    // render region labels
    svg.append('text')
      .text('SA Murray')
      .attr({ x: 18, y: 116, class: 'region-label' });
    svg.append('text')
      .text('336GL')
      .attr({ x: 18, y: 126, class: 'region-transfer' });

    svg.append('text')
      .text('Lower Darling')
      .attr({ x: 128, y: 74, class: 'region-label' });
    svg.append('text')
      .text('-28GL')
      .attr({ x: 128, y: 84, class: 'region-transfer' });

    svg.append('text')
      .text('NSW Murray')
      .attr({ x: 135, y: 149, class: 'region-label' });
    svg.append('text')
      .text('-135GL')
      .attr({ x: 135, y: 158, class: 'region-transfer' });

    svg.append('text')
      .text('Murrumbidgee')
      .attr({ x: 207, y: 133, class: 'region-label' });
    svg.append('text')
      .text('-390GL')
      .attr({ x: 230, y: 143, class: 'region-transfer' });

    svg.append('text')
      .text('VIC Murray')
      .attr({ x: 120, y: 182, class: 'region-label' });
    svg.append('text')
      .text('172GL')
      .attr({ x: 120, y: 191, class: 'region-transfer' });

    svg.append('text')
      .text('Goulburn')
      .attr({ x: 185, y: 240, class: 'region-label' });
    svg.append('text')
      .text('42GL')
      .attr({ x: 185, y: 250, class: 'region-transfer' });

    // render state labels
    svg.append('text')
      .text('SA')
      .attr({ x: 29, y: 50, class: 'state-label' });

    svg.append('text')
      .text('NSW')
      .attr({ x: 230, y: 50, class: 'state-label' });

    svg.append('text')
      .text('VIC')
      .attr({ x: 110, y: 235, class: 'state-label' });
  }

  render($vis.width());

}(d3, jQuery, _));
